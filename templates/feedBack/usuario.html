<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoTour - Feedback</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="{{ url_for('static', filename='images/logo_2.png') }}" alt="GoTour" width="80" height="50">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link active" href="/">Inicio</a>
                    <a class="nav-link" href="#">Usuarios</a>
                    <a class="nav-link" href="#">CIT</a>
                    <a class="nav-link" href="#">Informaci√≥n turistas</a>
                    <a class="nav-link" href="#">Sitios tur√≠sticos</a>
                    <a class="nav-link active" aria-current="page" href="/feedback">Comentarios</a>
                </div>
                <span class="navbar-text ms-auto">
                    {% if current_user.is_authenticated %}
                        <!-- Si est√° logueado, bot√≥n rojo con nombre -->
                        <a href="{{ url_for('user_bp.logout') }}" class="btn btn-danger">
                            Cerrar Sesi√≥n ({{ current_user.username }})
                        </a>
                    {% else %}
                        <!-- Si no est√° logueado, bot√≥n normal -->
                        <a href="{{ url_for('user_bp.login') }}" class="btn" style="background-color: orange; color: white;">
                            Registrarse / Iniciar Sesi√≥n
                        </a>
                    {% endif %}
                </span>
            </div>
        </div>
    </nav>

    <!-- Contenido -->
    <div class="container mt-4">
        <h1 class="text-center mb-4">Dej√° tu Feedback</h1>

        <!-- Formulario de Feedback -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form id="feedbackForm">

                    <!-- Selector din√°mico de sitios tur√≠sticos -->
                    <div class="mb-3">
                        <label for="touristSiteId" class="form-label">Lugar Tur√≠stico</label>
                        <select id="touristSiteId" class="form-control" required>
                            <option value="">-- Selecciona un sitio --</option>
                            {% for s in sites %}
                            <!-- üîπ Corregido: s.id -> s.id_tourist_site -->
                            <option value="{{ s.id_tourist_site }}">{{ s.name }} - {{ s.description }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="qualification" class="form-label">Calificaci√≥n (1-5)</label>
                        <input type="number" id="qualification" class="form-control" min="1" max="5" required>
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label">Comentario</label>
                        <textarea id="comment" class="form-control" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Usuario</label>
                        <input type="text" class="form-control" value="{{ current_user.first_name }} {{ current_user.last_name }}" readonly>
                    </div>

                    <button type="submit" class="btn btn-primary">Enviar</button>
                </form>
            </div>
        </div>

        <!-- √öltimos feedbacks -->
        <h2 class="mb-3">√öltimos comentarios</h2>
        <div class="row row-cols-1 row-cols-md-2 g-4" id="latestFeedbacks"></div>
    </div>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script de l√≥gica -->
    <script>
        const API_URL = "/api/feedback/";

        // Renderizar estrellas ‚≠ê
        function renderStars(qualification) {
            let stars = "";
            for (let i = 0; i < qualification; i++) stars += "‚≠ê";
            for (let i = qualification; i < 5; i++) stars += "‚òÜ";
            return stars;
        }

        // Cargar √∫ltimos feedbacks
        async function loadFeedbacks() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();

                const container = document.getElementById("latestFeedbacks");
                container.innerHTML = "";

                data.forEach(f => {
                    const card = document.createElement("div");
                    card.className = "col";
                    card.innerHTML = `
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h5 class="card-title">${renderStars(f.qualification)}</h5>
                                <p class="card-text">${f.comment}</p>
                                <div class="d-flex justify-content-between text-muted small">
                                    <span>üë§ ${f.user?.username || "Usuario"}</span>
                                    <span>üìç ${f.tourist_site?.name || "Sitio"}</span>
                                    <span>üìÖ ${f.date_hour ? new Date(f.date_hour).toLocaleDateString() : ""}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (err) {
                console.error("Error cargando feedbacks:", err);
            }
        }

        // Enviar nuevo feedback
        document.getElementById("feedbackForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const newFeedback = {
                comment: document.getElementById("comment").value,
                qualification: parseInt(document.getElementById("qualification").value),
                // üîπ id_user eliminado, backend usa current_user
                id_tourist_site: document.getElementById("touristSiteId").value
            };

            console.log("Enviando feedback:", newFeedback); // üëÄ debug

            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(newFeedback)
                });

                await res.json();
                loadFeedbacks();
                document.getElementById("feedbackForm").reset();
            } catch (err) {
                console.error("Error enviando feedback:", err);
            }
        });

        // Cargar feedbacks al inicio
        loadFeedbacks();
    </script>
</body>
</html>
