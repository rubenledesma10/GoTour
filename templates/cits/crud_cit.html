<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Centros de Información Turística (CIT)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body id="protectedBody"> 
    
    {% include "partials/navbar.html" %}

    <div class="container mt-4">
        <h2>Centros de Información Turística (CIT)</h2>

        <div class="mb-3 admin-only" style="display:none;">
            <button id="btnAdd" class="btn btn-success">Agregar CIT</button>
        </div>

        <table class="table table-striped table-bordered mt-3">
            <thead class="table-dark">
                <tr>
                    <th class="admin-only" style="display:none;">Editar</th> 
                    <th>Distrito</th>
                    <th>Dirección</th>
                    <th>Número CIT</th>
                    <th>Activo</th>
                    <th>QR Map Activo</th>
                    <th class="admin-only" style="display:none;">Eliminar</th>
                </tr>
            </thead>
            <tbody id="citTableBody">
                {% for cit in cits %}
                <tr data-id="{{ cit.id_cit }}">
                    <td class="admin-only" style="display:none;">
                        <input type="checkbox" class="edit-toggle">
                    </td>

                    <td class="cit-district" contenteditable="false">{{ cit.district }}</td>
                    <td class="cit-address" contenteditable="false">{{ cit.address }}</td>
                    <td class="cit-number-cit" contenteditable="false">{{ cit.number_cit }}</td>
                    <td><input type="checkbox" disabled {% if cit.is_activate %}checked{% endif %}></td>
                    <td><input type="checkbox" disabled {% if cit.is_activate_qr_map %}checked{% endif %}></td>

                    <td class="admin-only" style="display:none;">
                        <button class="btn btn-danger btn-sm btnDeleteRow">Eliminar</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7">No hay CITs cargados</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div id="addFormContainer" class="admin-only mt-4" style="display:none;">
            <h4>Agregar nuevo CIT</h4>
            <form id="addCitForm" class="border p-3 rounded">
                <div class="mb-3">
                    <label for="district" class="form-label">Distrito:</label>
                    <input type="text" id="district" name="district" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="address" class="form-label">Dirección:</label>
                    <input type="text" id="address" name="address" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="number_cit" class="form-label">Número CIT:</label>
                    <input type="text" id="number_cit" name="number_cit" class="form-control" required>
                </div>
                <div class="form-check mb-2">
                    <input type="checkbox" id="is_activate" name="is_activate" class="form-check-input">
                    <label for="is_activate" class="form-check-label">Activo</label>
                </div>
                <div class="form-check mb-3">
                    <input type="checkbox" id="is_activate_qr_map" name="is_activate_qr_map" class="form-check-input">
                    <label for="is_activate_qr_map" class="form-check-label">QR Map Activo</label>
                </div>
                <button type="submit" class="btn btn-primary">Guardar CIT</button>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        const role = token ? localStorage.getItem('role') : null;

        // Si no hay token, solo mostramos el cuerpo y ocultamos las cosas de admin.
        // No redirigimos para que el turista vea la tabla (aunque el URL no sea el ideal).
        // Si no estás logueado, esta es la vista de turista.
        document.getElementById('protectedBody').style.display = 'block';

        // Ocultar/Mostrar elementos de administración
        if (role === 'admin') {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'table-cell');
            // Nota: Se usa 'table-cell' para las <th> y <td>, y 'block' para los divs.
            document.querySelectorAll('.admin-only').forEach(el => {
                if (el.tagName !== 'TD' && el.tagName !== 'TH') {
                    el.style.display = 'block';
                }
            });
        } else {
            // Si no es admin, aseguramos que todo de admin esté oculto
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        }

        // --- Agregar CIT (POST) ---
        const addForm = document.getElementById('addCitForm');
        if (addForm) {
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!token || role !== 'admin') return alert("⚠️ Solo administradores pueden agregar CITs.");

                // El método FormData funciona bien con el backend de Flask request.form.to_dict()
                const formData = new FormData(e.target);
                
                // Convertir checkboxes a 'true' o 'false' para Flask si no están marcados
                if (!formData.has('is_activate')) formData.set('is_activate', 'false');
                if (!formData.has('is_activate_qr_map')) formData.set('is_activate_qr_map', 'false');

                try {
                    const res = await fetch('/api/cit/', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData // No Content-Type, FormData lo maneja.
                    });
                    const data = await res.json();
                    if (res.ok) {
                        alert("✅ CIT agregado correctamente.");
                        location.reload(); 
                    } else {
                        alert("❌ Error al crear: " + (data.error || data.message));
                    }
                } catch(err) {
                    alert("⚠️ Error de conexión: " + err.message);
                }
            });
        }

        // --- Editar Inline (PATCH) ---
        document.querySelectorAll('.edit-toggle').forEach(cb => {
            cb.addEventListener('change', async e => {
                const row = e.target.closest('tr');
                const id = row.dataset.id;
                const editableFields = row.querySelectorAll('.cit-district, .cit-address, .cit-number-cit');

                // Habilitar/Deshabilitar edición
                editableFields.forEach(td => td.contentEditable = e.target.checked);

                if (!e.target.checked) {
                    // Si se desmarca el checkbox, intentamos guardar (PATCH)
                    const updatedData = {
                        district: row.querySelector('.cit-district').innerText.trim(),
                        address: row.querySelector('.cit-address').innerText.trim(),
                        number_cit: row.querySelector('.cit-number-cit').innerText.trim()
                    };
                    
                    if (!token || role !== 'admin') return alert("⚠️ Error de permisos.");
                    
                    try {
                        const res = await fetch(`/api/cit/${id}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json' // Mandamos JSON
                            },
                            body: JSON.stringify(updatedData)
                        });
                        const data = await res.json();
                        if (!res.ok) alert("❌ Error al actualizar: " + (data.error || data.message));
                        else alert("✅ CIT actualizado correctamente.");

                    } catch(err) {
                        alert("⚠️ Error al actualizar: " + err.message);
                    }
                }
            });
        });

        // --- Eliminar Fila (DELETE) ---
        document.querySelectorAll('.btnDeleteRow').forEach(btn => {
            btn.addEventListener('click', async e => {
                if (!confirm("¿Estás seguro de eliminar este CIT?")) return;
                
                const row = e.target.closest('tr');
                const id = row.dataset.id;
                
                if (!token || role !== 'admin') return alert("⚠️ Solo administradores pueden eliminar.");

                try {
                    // ⚠️ Utilizamos DELETE directamente al endpoint principal
                    const res = await fetch(`/api/cit/${id}`, {
                        method: 'DELETE', 
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();
                    
                    if (res.ok) {
                        alert(data.message || "✅ Eliminado correctamente.");
                        row.remove();
                    } else {
                        alert("❌ Error al eliminar: " + (data.error || data.message));
                    }
                } catch(err) {
                    alert("⚠️ Error de conexión: " + err.message);
                }
            });
        });
        
        // Toggle formulario Agregar CIT (aseguramos que se ejecuta si es admin)
        const btnAdd = document.getElementById('btnAdd');
        if (btnAdd) {
            btnAdd.addEventListener('click', () => {
                const form = document.getElementById('addFormContainer');
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            });
        }
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>