{% include "head.html" %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tourist_sites.css') }}">

<body id="protectedBody" style="display: none;">

    {% include "partials/navbar.html" %}

    <div class="container mt-4">
        <h2 class="mb-4 mt-3">Sitios Turísticos Creados</h2>


        <div class="card mb-4 shadow-sm border-0 p-3 rounded-3">
            <div class="d-flex flex-wrap align-items-center gap-2">
                <input type="text" id="searchInput" class="form-control flex-grow-1"
                    placeholder="Buscar por nombre, descripción o dirección..." style="min-width: 250px;">

                <select id="categoryFilter" class="form-select" style="min-width: 200px;">
                    <option value="">Todas las categorías</option>
                    <option value="Bodegas">Bodegas</option>
                    <option value="Olivicolas">Olivícolas</option>
                    <option value="Alojamiento">Alojamiento / Hotelería</option>
                    <option value="Gastronomia">Gastronomía</option>
                    <option value="Servicios Turisticos">Servicios Turísticos</option>
                    <option value="Turismo Rural">Turismo Rural</option>
                </select>

                <select id="statusFilter" class="form-select" style="min-width: 150px;">
                    <option value="">Todos los estados</option>
                    <option value="true">Activos</option>
                    <option value="false">Inactivos</option>
                </select>

                <button class="btn btn-primary px-3" id="btnSearch">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>

        <!-- Solo visible para administradores -->
        <h3 class="admin-only">¿Qué deseas hacer?</h3>
        <a href="/tourist_sites/add" class="btn btn-primary mb-2 admin-only">Agregar sitio turístico</a>
        <a href="/tourist_sites/edit" class="btn btn-warning mb-2 text-white admin-only">Editar sitio turístico</a>
        <a href="/tourist_sites/delete" class="btn btn-danger mb-2 admin-only">Eliminar sitio turístico</a>

        <!--  Listado de sitios -->
        <div class="row row-cols-1 row-cols-md-3 g-4 mt-4">
            {% for site in sites %}
            <div class="col">
                <div class="card h-100 shadow-sm border-0">
                    {% if site.photo %}
                    <img src="{{ url_for('static', filename='tourist_sites_images/' ~ site.photo) }}"
                        class="card-img-top site-photo" alt="{{ site.name }}"
                        style="height: 200px; object-fit: cover; cursor: pointer;" data-bs-toggle="modal"
                        data-bs-target="#imageModal"
                        data-img-src="{{ url_for('static', filename='tourist_sites_images/' ~ site.photo) }}"
                        data-img-name="{{ site.name }}">
                    {% else %}
                    <div class="bg-light text-muted text-center py-5">Sin imagen</div>
                    {% endif %}

                    <div class="card-body">
                        <a href="{{ url_for('feedback_bp.feedback_add_form', site_id=site.id_tourist_site, name=site.name) }}"
                            class="btn btn-success btn-sm btn-send-comment">
                            <i class="bi bi-chat-dots"></i> Comentar
                        </a>


                        <h5 class="card-title text-primary mt-2">{{ site.name }}</h5>
                        <p class="mb-1"><strong>Descripción:</strong> {{ site.description }}</p>
                        <p class="text-muted mb-1"><i class="bi bi-geo-alt-fill"></i> {{ site.address }}</p>
                        <p class="text-muted mb-1"><i class="bi bi-telephone-fill"></i> {{ site.phone }}</p>
                        <p class="text-muted mb-1"><i class="bi bi-clock"></i>
                            {{ site.opening_hours }} - {{ site.closing_hours }}
                        </p>
                        <p class="text-muted mb-1">
                            <i class="bi bi-bar-chart-line"></i> Promedio visitas:
                            <strong>{{ "{:,.2f}".format(site.average or 0) }}</strong>
                        </p>
                        <p class="text-muted"><i class="bi bi-tag-fill"></i> {{ site.category }}</p>
                    </div>

                    <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
                        <div>
                            {% if site.url %}
                            <a href="{{ site.url }}" target="_blank" class="btn btn-outline-primary btn-sm me-2">
                                <i class="bi bi-box-arrow-up-right"></i> Ver sitio
                            </a>
                            {% endif %}

                            {% if not site.is_activate %}
                            <button class="btn btn-success btn-sm btn-reactivate admin-only"
                                data-id="{{ site.id_tourist_site }}">
                                <i class="bi bi-arrow-clockwise"></i> Reactivar
                            </button>
                            {% endif %}
                        </div>

                        {% if site.is_activate %}
                        <span class="badge bg-success">Activo</span>
                        {% else %}
                        <span class="badge bg-secondary">Inactivo</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Modal para ver imagen ampliada -->
        <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel">Vista ampliada</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="modalImage" src="" alt="" class="img-fluid rounded shadow">
                    </div>
                </div>
            </div>
        </div>

        <!-- Script para modal -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const modalImage = document.getElementById('modalImage');
                const modalTitle = document.getElementById('imageModalLabel');

                document.querySelectorAll('.site-photo').forEach(img => {
                    img.addEventListener('click', () => {
                        const imgSrc = img.getAttribute('data-img-src');
                        const imgName = img.getAttribute('data-img-name');
                        modalImage.src = imgSrc;
                        modalTitle.textContent = `Vista ampliada - ${imgName}`;
                    });
                });
            });
        </script>
    </div>

    <!-- JS -->
    <script src="/static/tourist_sites/tourist_sites.js"></script>


    {% include "scripts.html" %}