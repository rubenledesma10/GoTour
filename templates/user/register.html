{% include "head.html" %}
{% include "partials/navbar.html" %}

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
      <div class="card shadow-lg rounded-4 border-0">
        <div class="card-body p-5">
          <h2 class="text-center text-primary fw-bold mb-4">
            üëã Bienvenido a la familia de GoTour! üòé
          </h2>

          <form id="registerForm" enctype="multipart/form-data">
            <!-- Nombre y Apellido -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="first_name" class="form-label">Nombre</label>
                <input type="text" class="form-control rounded-3 shadow-sm" id="first_name" name="first_name"
                  placeholder="Ingrese su nombre" required minlength="2" maxlength="50">
              </div>
              <div class="col-md-6">
                <label for="last_name" class="form-label">Apellido</label>
                <input type="text" class="form-control rounded-3 shadow-sm" id="last_name" name="last_name"
                  placeholder="Ingrese su apellido" required minlength="2" maxlength="50">
              </div>
            </div>

            <!-- Email y Usuario -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="email" class="form-label">Correo electr√≥nico</label>
                <input type="email" class="form-control rounded-3 shadow-sm" id="email" name="email"
                  placeholder="ejemplo@correo.com" required>
              </div>
              <div class="col-md-6">
                <label for="username" class="form-label">Nombre de usuario</label>
                <input type="text" class="form-control rounded-3 shadow-sm" id="username" name="username"
                  placeholder="Ingrese un nombre de usuario" required minlength="3">
              </div>
            </div>

            <!-- Contrase√±a y Repetir -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="password" class="form-label">Contrase√±a</label>
                <div class="input-group">
                  <input type="password" class="form-control rounded-3 shadow-sm" id="password" name="password"
                    placeholder="M√≠nimo 6 caracteres" required minlength="6">
                  <button type="button" id="togglePassword" class="btn btn-outline-secondary">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>

              <div class="col-md-6">
                <label for="confirm_password" class="form-label">Repetir Contrase√±a</label>
                <div class="input-group">
                  <input type="password" class="form-control rounded-3 shadow-sm" id="confirm_password" name="confirm_password"
                    placeholder="Repite tu contrase√±a" required minlength="6">
                  <button type="button" id="toggleConfirmPassword" class="btn btn-outline-secondary">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- DNI y Tel√©fono -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="dni" class="form-label">DNI</label>
                <input type="text" class="form-control rounded-3 shadow-sm" id="dni" name="dni"
                  placeholder="Ingrese su DNI" required minlength="7" maxlength="20">
              </div>
              <div class="col-md-6">
                <label for="phone" class="form-label">Tel√©fono</label>
                <input type="tel" class="form-control rounded-3 shadow-sm" id="phone" name="phone"
                  placeholder="Ej: +54 9 261 1234567" required>
              </div>
            </div>

            <!-- Fecha de nacimiento y G√©nero -->
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="birthdate" class="form-label">Fecha de nacimiento</label>
                <input type="date" class="form-control rounded-3 shadow-sm" id="birthdate" name="birthdate" required>
              </div>
              <div class="col-md-6">
                <label for="gender" class="form-label">G√©nero</label>
                <select class="form-select rounded-3 shadow-sm" id="gender" name="gender" required>
                  <option value="" disabled selected>Seleccione una opci√≥n</option>
                  <option value="masculino">Masculino</option>
                  <option value="femenino">Femenino</option>
                  <option value="prefiero no decirlo">Prefiero no decirlo</option>
                </select>
              </div>
            </div>

            <!-- Pa√≠s y Provincia -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label for="countrySelect" class="form-label">Pa√≠s</label>
                <select class="form-select rounded-3 shadow-sm" id="countrySelect" name="nationality" required>
                  <option value="" disabled selected>Seleccione un pa√≠s</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="stateSelect" class="form-label">Provincia</label>
                <select class="form-select rounded-3 shadow-sm" id="stateSelect" name="province" required>
                  <option value="" disabled selected>Seleccione una provincia</option>
                </select>
              </div>
            </div>

            <!-- Foto de perfil -->
            <div class="mb-4 text-center">
              <label for="photo" class="form-label">Foto de perfil (opcional)</label><br>

              <!-- Bot√≥n para usar c√°mara -->
              <button type="button" id="openCameraBtn"
                class="form-control rounded-3 shadow-sm w-75 mx-auto mb-3 text-secondary border"
                style="background-color: #e9ecef;">
                üì∑ Tomar foto 
              </button>

              <!-- Vista previa -->
              <img id="preview" src="" class="d-none rounded-3 shadow" width="220">

              <!-- Input tradicional -->
              <input class="form-control rounded-3 shadow-sm w-75 mx-auto mt-3" type="file" id="photoInput" name="photo" accept="image/*">

              <!-- C√°mara -->
              <div id="cameraContainer" class="d-none mt-3">
                <video id="camera" width="250" height="200" autoplay class="border rounded"></video><br>

                <button type="button" id="takePhotoBtn"
                  class="btn btn-success rounded-3 shadow-sm px-4 mt-2 me-2">
                  üì∏ Capturar Foto
                </button>

                <button type="button" id="cancelCameraBtn"
                  class="btn btn-outline-danger rounded-3 shadow-sm px-4 mt-2">
                  ‚ùå Cancelar
                </button>
              </div>
            </div>

            <!-- Canvas oculto -->
            <canvas id="photoCanvas" width="250" height="200" class="d-none"></canvas>

            


            <!-- Estado del correo -->
            <div id="emailStatus" class="text-center mb-3 fw-bold" style="font-size: 1.1em; color: orange;"></div>

            <!-- Botones -->
            <div class="d-flex justify-content-center gap-3">
              <button type="submit" class="btn btn-success px-5 shadow-sm">Registrar</button>
              <a href="{{ url_for('user_bp.login') }}" class="btn btn-secondary px-5 shadow-sm">Cancelar</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
  <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">Mensaje</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

{% include "scripts.html" %}

<script>
const openCameraBtn = document.getElementById('openCameraBtn');
const cameraContainer = document.getElementById('cameraContainer');
const video = document.getElementById('camera');
const canvas = document.getElementById('photoCanvas');
const takePhotoBtn = document.getElementById('takePhotoBtn');
const cancelCameraBtn = document.getElementById('cancelCameraBtn');
const preview = document.getElementById('preview');
const photoInput = document.getElementById('photoInput');

let stream = null;

// Abrir c√°mara
openCameraBtn.addEventListener('click', async () => {
  cameraContainer.classList.remove("d-none");
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  } catch (err) {
    alert("No se pudo acceder a la c√°mara.");
  }
});

// Capturar foto
takePhotoBtn.addEventListener('click', () => {
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const dataURL = canvas.toDataURL("image/png");
  preview.src = dataURL;
  preview.classList.remove("d-none");

  fetch(dataURL)
    .then(res => res.blob())
    .then(blob => {
      const file = new File([blob], "photo.png", { type: "image/png" });
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      photoInput.files = dataTransfer.files;
    });

  cameraContainer.classList.add("d-none");
  if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
});

// Cancelar c√°mara
cancelCameraBtn.addEventListener('click', () => {
  cameraContainer.classList.add("d-none");
  if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
});
</script>
